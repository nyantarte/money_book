<html>
    <head>
        <script>
            const MODE_FILE_PICK=0;
            const MODE_MONTHLY_LIST=1;
            const MODE_ADD_TRANSACTION=2;
            const MODE_EDIT_METHODS=3;
            const MODE_EDIT_USAGES=4;
            class Transaction{
                id=0;
                target_date=null;
                method="";
                usage="";
                note="";

                static parseFromCSVData(src){
                    var params=src.split(",");
                    var result=new Transaction();
                    result.id=params[0];
                    result.target_date=params[1];
                    result.method=params[2];
                    result.usage=params[3];
                    result.note=params[4];
                    return result;
                }
            }
            class MoneyBook{
                transactions=new Array();
                methods=new Array();
                usages=new Array();
            }

            class App{
                state_stack=[MODE_FILE_PICK];
                current_date=new Date();
                data=new MoneyBook();

                set_mode(next_mode){
                    this.state_stack.push(next_mode);
                }
                set_prev_mode(){
                    this.state_stack.pop();
                }
                get_state(){
                    return this.state_stack[this.state_stack.length-1];
                }

                get_date_string_for_input(){
                    var tmp=this.current_date.getFullYear();
                    if(9>this.current_date.getMonth()){
                        tmp=tmp+"-0"+(this.current_date.getMonth()+1);
                    }else{
                        tmp=tmp+"-"+(this.current_date.getMonth()+1);
                    }

                    if(9>this.current_date.getDay()){
                        tmp=tmp+"-0"+(this.current_date.getDay()+1);
                    }else{
                        tmp=tmp+"-"+(this.current_date.getDay()+1);
                    }
                    return tmp;
                }
                get_time_string_for_input(){
                    var tmp="";
                    if(10>this.current_date.getHours()){
                        tmp="0"+(this.current_date.getHours());
                    }else{
                        tmp=(this.current_date.getHours());
                    }

                    if(10>this.current_date.getMinutes()){
                        tmp=tmp+":0"+(this.current_date.getMinutes());
                    }else{
                        tmp=tmp+":"+(this.current_date.getMinutes());
                    }
                    return tmp;
                }

            }
            var app=new App();

            function remove_nodes(){
                //現在の画面を削除
                while(0 < document.body.childNodes.length){
                    document.body.childNodes[0].remove();
                }

            }
            //ページを初期化する
            function init(){
                remove_nodes();

                //ファイルオープンモード
                if(MODE_FILE_PICK==app.get_state()){
                    
                    //ファイルオープン画面を表示する
                    var create_btn=document.createElement("input");
                    create_btn.type="button";
                    create_btn.onclick=on_create_new;
                    create_btn.value="新規作成";
                    document.body.appendChild(create_btn);
                    //ファイル参照ボタンを追加
                    var input_file=document.createElement("input");
                    input_file.type="file";
                    input_file.id="filePicker";
                    input_file.addEventListener("change",file_load);
                    
                    document.body.appendChild(input_file);

                    
                }else if(MODE_MONTHLY_LIST==app.get_state()){
                    create_menu();
                    show_monthly_list();

                }else if(MODE_ADD_TRANSACTION==app.get_state()){
                    edit_transaction();
                }else if(MODE_EDIT_METHODS==app.get_state()){
                    show_method_list();
                }
            }

            function file_load(){
                var files=document.getElementById("filePicker").files;
                for(var i=0; i< files.length;++i){
                    var item=files[i];
                    console.log("file_load(Info)>>Target file name is "+item.name); 
                    
                    //フォーマットチェック

                    //CSV形式以外はエラー
                    console.log("file_load(Info)>>File type is "+item.name.substr(item.name.length-4));
                    if(4 >=item.name.length || ".csv"!=item.name.substr(item.name.length-4)){
                        alert(item.name+"はCSV形式ではありません。");
                    }else{

                        console.log("file_load(Info)>>File type check is passed.");
                        var reader=new FileReader();

                        reader.onload=on_file_loaded;
                        reader.readAsText(item);

                    }
                
                }
            }

            //ファイルからオブジェクトを復元
            function on_file_loaded(evt){
                console.log("on_file_load(Info)>>Begin file parsing");
                var lines=evt.target.result.split("\n");
                console.log(lines);

                data=new MoneyBook();

                for(var i=0;i < lines.length;++i){
                    var param_line=lines[i];
                    if(0<param_line.length){
                        data.transactions.push(Transaction.parseFromCSVData(param_line));
                    }
                }
            }

            //新規作成時の処理
            function on_create_new(){
                console.log("on_create_new(Info)>>Create a new money book.");
                
                app.set_mode(MODE_MONTHLY_LIST);
                init();
            }

            function create_menu(){
                var menu_tbl=document.createElement("menu");
                menu_tbl.type="toolbar";
                var item=document.createElement("input");
                item.type="button";
                item.onclick=on_monthly_click;
                item.value="Monthly";
                menu_tbl.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.value="Daily";
                menu_tbl.appendChild(item);
                document.body.appendChild(menu_tbl);
                

            }
            function show_monthly_list(){
                var add_btn=document.createElement("input");
                add_btn.type="button";
                add_btn.value="+";
                add_btn.onclick=on_add_transaction;
                document.body.appendChild(add_btn);
                console.log("show_monthly_list(Info)>>Generateing item list begin");
                var trans_list=new Array();
                for(var i=0;i < app.data.transactions.length;++i){
                    var item=app.data.transactions[i];
                    if(app.current_date.getFullYear()==item.getFullYear() &&
                        app.current_date.getMonth()==item.getMonth()){
                        trans_list.push(item);
                    }
                }
                for(var i=0;i < trans_list.length;++i){
                    var item=trans_list[i];
                    document.body.appendChild(document.createTextNode(item.toString()));
                    var btn=document.createElement("input");
                    btn.type="button";
                    btn.value="edit";
                    document.body.appendChild(btn);

                }
                console.log("show_monthly_list(Info)>>Generateing item list end");
            }
            function show_method_list(){
                
                var item=null;
                
                var item_list=document.createElement("div");
                item_list.id="method_list";

                
                for(var i=0;i < app.data.methods.length;++i){
                    item=document.createElement("input");
                    item.type="checkbox";
                    item.name="methods";
                    item_list.appendChild(item);
                    item_list.appendChild(document.createTextNode(app.data.methods[i]));
                    item_list.appendChild(document.createElement("br"));
                }
                document.body.appendChild(item_list);

                item=document.createElement("input");
                item.type="button";
                item.value="DELETE";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="text";
                item.id="new_method";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.value="ADD";
                item.onclick=add_method;
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.value="OK";
                item.onclick=goback_state;
                document.body.appendChild(item);


            }
            function on_add_transaction(){
                app.set_mode(MODE_ADD_TRANSACTION);
                init();
            }
            function edit_transaction(){
                var item=document.createTextNode("Date");
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="date";
                item.id="target_date";
                item.value=app.get_date_string_for_input();

                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="time";
                item.id="target_time";
                item.value=app.get_time_string_for_input();
                document.body.appendChild(item);

                document.body.appendChild(document.createElement("br"));
                item=document.createTextNode("Type");
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="radio";
                item.name="transaction_type";
                item.id="target_income";
               item.value="true";
                document.body.appendChild(item);
                document.body.appendChild(document.createTextNode("Income"));
                item=document.createElement("input");
                item.type="radio";
                item.name="transaction_type";
                item.id="target_payment";
                item.value="false";
                document.body.appendChild(item);
                document.body.appendChild(document.createTextNode("Payment"));
                document.body.appendChild(document.createElement("br"));


                document.body.appendChild(document.createTextNode("Method"));
                item=document.createElement("select");
                item.id="target_method";
                for(var i=0;i < app.data.methods.length;++i){
                    var tmp=document.createElement("option");
                    tmp.appendChild(document.createTextNode(app.data.methods[i]));
                    item.appendChild(tmp);
                }
                
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=edit_method;
                item.value="Add";
                document.body.appendChild(item);

                document.body.appendChild(document.createElement("br"));
                document.body.appendChild(document.createTextNode("Usage"));
                item=document.createElement("select");
                item.id="target_usage";

                for(var i=0;i < app.data.usages.length;++i){
                    var tmp=document.createElement("option");
                    tmp.value=app.data.usages[i];
                    item.appendChild(tmp);
                }
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=edit_usages;
                item.value="Add";
                document.body.appendChild(item);

                document.body.appendChild(document.createElement("br"));

                document.body.appendChild(document.createTextNode("note"));
                item=document.createElement("input");
                item.type="text";
                item.id="target_note";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                document.body.appendChild(document.createTextNode("value"));
                item=document.createElement("input");
                item.type="text";
                item.id="target_value";
                item.value="0";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="AC";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="BS";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="%";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="/";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(7);};
                item.value="7";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(8);};
                item.value="8";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(9);};
                item.value="9";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="*";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(4);};
                item.value="4";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(5);};
                item.value="5";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(6);}
                item.value="6";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="-";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(1);};
                item.value="1";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(2);};
                item.value="2";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(3);}
                item.value="3";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=clear_value;
                item.value="+";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(0);};
                item.value="0";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=function(){add_value(".");};
                item.value=".";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=calc_value;
                item.value="=";
                document.body.appendChild(item);
                document.body.appendChild(document.createElement("br"));

                item=document.createElement("input");
                item.type="button";
                item.onclick=regist_transaction;
                item.value="OK";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=delete_transaction;
                item.value="DELETE";
                document.body.appendChild(item);
                item=document.createElement("input");
                item.type="button";
                item.onclick=goback_state;
                item.value="CANCEL";
                document.body.appendChild(item);
            }
            function on_monthly_click(){
                app.set_mode(MODE_MONTHLY_LIST);
                init();
            }

            function edit_method(){
                app.set_mode(MODE_EDIT_METHODS);
                init();
            }
            function edit_usages(){
                app.set_mode(MODE_EDIT_USAGES);
                init();

            }
            function clear_value(){}
            function add_value(v){

            }
            function calc_value(){}
            function regist_transaction(){}
            function goback_state(){
               app.set_prev_mode();
                init();
            }
            function delete_transaction(){}
            function add_method(){
                var item=document.getElementById("new_method");
                console.log(item.value);
                app.data.methods.push(item.value);
                var item_list=document.getElementById("method_list");
                var new_item=document.createElement("input");
                new_item.type="checkbox";
                new_item.name="methods";
                item_list.appendChild(new_item);
                item_list.appendChild(document.createTextNode(item.value));
                item_list.appendChild(document.createElement("br"));
            }
        </script>
    </head>
    <body onload="init()">
    </body>
</html>